<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Study Time Tracker</title>
<style>
  :root{
    --bg:#f6f7fb;--card:#fff;--muted:#6b7280;--accent:#2563eb;
    --glass: rgba(255,255,255,0.6);
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;
    background:linear-gradient(180deg,#eef2ff 0%,var(--bg) 100%);color:#111}
  .container{max-width:980px;margin:28px auto;padding:20px}
  .card{background:var(--card);border-radius:14px;padding:18px;box-shadow:0 6px 18px rgba(20,20,50,0.06);margin-bottom:18px}
  header{display:flex;align-items:center;gap:16px}
  h1{font-size:20px;margin:0}
  p.lead{margin:6px 0 0;color:var(--muted);font-size:13px}
  .grid{display:grid;grid-template-columns:1fr 360px;gap:16px}
  @media(max-width:880px){.grid{grid-template-columns:1fr}}
  #player-area{min-height:220px;border-radius:10px;overflow:hidden;background:#000;display:flex;align-items:center;justify-content:center}
  label{font-size:12px;color:var(--muted);display:block;margin-bottom:6px}
  input[type=text], input[type=number], select{width:100%;padding:10px;border-radius:8px;border:1px solid #e6e9ef;background:#fff}
  .controls{display:flex;gap:8px;margin-top:10px}
  button{padding:10px 12px;border-radius:8px;border:0;background:var(--accent);color:#fff;cursor:pointer}
  button.ghost{background:transparent;color:var(--accent);border:1px solid #dbe6ff}
  .progress-wrap{display:flex;align-items:center;gap:18px}
  .ring{width:120px;height:120px;border-radius:999px;background:conic-gradient(var(--accent) 0deg,var(--accent) var(--deg,0deg),#e6eefc var(--deg,0deg));display:flex;align-items:center;justify-content:center;box-shadow:0 6px 18px rgba(37,99,235,0.08)}
  .ring .inner{width:92px;height:92px;border-radius:999px;background:var(--card);display:flex;flex-direction:column;align-items:center;justify-content:center}
  .big{font-weight:700;font-size:20px}
  .muted{color:var(--muted);font-size:12px}
  .stats-row{display:flex;gap:12px;margin-top:12px;flex-wrap:wrap}
  .stat{background:linear-gradient(180deg,#fff, #fbfdff);padding:10px;border-radius:10px;min-width:130px;flex:1}
  .history{max-height:300px;overflow:auto;margin-top:6px}
  .session{padding:8px;border-radius:8px;border:1px solid #f1f5fb;margin-bottom:8px;display:flex;justify-content:space-between;gap:12px}
  .small{font-size:13px;color:var(--muted)}
  .actions{display:flex;gap:8px}
  footer{display:flex;justify-content:space-between;gap:12px;align-items:center}
  a.link{color:var(--accent);text-decoration:none;font-size:13px}
  .note{font-size:12px;color:var(--muted);margin-top:8px}
</style>
</head>
<body>
<div class="container">
  <div class="card">
    <header>
      <div>
        <h1>Study Time Tracker (YouTube + Manual)</h1>
        <p class="lead">Paste a YouTube link, set your study target, and this page will count the actual watched seconds and show progress. Data stored locally on this device.</p>
      </div>
    </header>
  </div>

  <div class="grid">
    <div>
      <div class="card">
        <label for="yt-url">YouTube video URL</label>
        <input id="yt-url" type="text" placeholder="https://www.youtube.com/watch?v=..." />
        <div class="controls">
          <button id="load-btn">Load Video</button>
          <button id="clear-video" class="ghost">Remove</button>
          <button id="export-csv" class="ghost">Export CSV</button>
        </div>
        <div id="player-area" style="margin-top:12px">
          <div id="player-placeholder" style="color:#fff;font-size:15px">No video loaded</div>
          <div id="player"></div>
        </div>

        <div style="margin-top:12px;display:flex;gap:8px;align-items:center;flex-wrap:wrap">
          <div style="flex:1">
            <label>Study target (hours)</label>
            <input id="target-hours" type="number" min="0.1" step="0.1" value="5" />
          </div>
          <div style="width:160px">
            <label>Manual add (minutes)</label>
            <input id="manual-min" type="number" min="1" step="1" value="10" />
          </div>
          <div style="align-self:end">
            <button id="add-manual" class="">Add</button>
          </div>
        </div>

        <div class="note">Tip: While the video plays, the tracker counts only time when the player is actually playing. You can also add manual sessions if you studied without video.</div>
      </div>

      <div class="card">
        <h3 style="margin:0 0 8px 0">Session history</h3>
        <div class="history" id="history"></div>
        <div style="margin-top:8px;display:flex;gap:8px;justify-content:flex-end">
          <button id="reset" class="ghost">Reset data</button>
        </div>
      </div>
    </div>

    <aside>
      <div class="card">
        <div class="progress-wrap">
          <div class="ring" id="ring" style="--deg:0deg">
            <div class="inner">
              <div class="big" id="percent">0%</div>
              <div class="muted" id="time-text">0 min</div>
            </div>
          </div>
          <div style="flex:1">
            <div style="display:flex;justify-content:space-between;align-items:center">
              <div><strong>Total studied</strong></div>
              <div class="small" id="total-time-sm">0m</div>
            </div>
            <div class="stats-row">
              <div class="stat">
                <div class="small">Sessions</div>
                <div id="total-sessions">0</div>
              </div>
              <div class="stat">
                <div class="small">Today</div>
                <div id="today-time">0m</div>
              </div>
            </div>
          </div>
        </div>

        <div style="margin-top:12px">
          <div class="small">Export or backup your study log with "Export CSV". Data is saved only in your browser's local storage.</div>
        </div>
      </div>

      <div class="card" style="text-align:center">
        <div style="font-size:14px;font-weight:600">Quick actions</div>
        <div style="margin-top:10px;display:flex;gap:8px;justify-content:center">
          <button id="jump-10" class="ghost">+10m</button>
          <button id="jump-30" class="ghost">+30m</button>
        </div>
        <div style="margin-top:12px">
          <a class="link" href="#" id="how-it-works">How it works</a>
        </div>
      </div>
    </aside>
  </div>

  <footer style="max-width:980px;margin:18px auto 60px">
    <div class="small">Local demo • No accounts • Want multi-device sync? Ask and I’ll add a simple backend.</div>
    <div class="small">Made for quick study tracking</div>
  </footer>
</div>

<!-- YouTube IFrame API -->
<script src="https://www.youtube.com/iframe_api"></script>
<script>
/*
Simple Study Time Tracker - front-end only
Stores data in localStorage as: studyData { sessions:[], totals:{seconds}, perVideo:{videoId:seconds} }
Tracks time by polling player.getCurrentTime while state=playing
*/
const STORAGE_KEY = 'study-tracker-v1';

let player = null;
let isPlaying = false;
let lastPlayerTime = 0;
let lastPoll = 0;
let currentVideoId = null;

function loadStorage(){
  const raw = localStorage.getItem(STORAGE_KEY);
  if(!raw) return {sessions:[], totals:{seconds:0}, perVideo:{}, lastSessionId:0};
  try{return JSON.parse(raw)}catch(e){return {sessions:[], totals:{seconds:0}, perVideo:{}, lastSessionId:0}}
}
function saveStorage(obj){localStorage.setItem(STORAGE_KEY, JSON.stringify(obj))}

let data = loadStorage();

function createSession(durationSeconds, source='manual', videoId=null){
  const id = (data.lastSessionId||0) + 1;
  data.lastSessionId = id;
  const session = {
    id, durationSeconds, source, videoId,
    ts: (new Date()).toISOString()
  };
  data.sessions.unshift(session);
  data.totals.seconds = (data.totals.seconds || 0) + durationSeconds;
  if(videoId){
    data.perVideo[videoId] = (data.perVideo[videoId]||0) + durationSeconds;
  }
  saveStorage(data);
  refreshUI();
}
function secondsToHuman(s){
  if(!s) return '0m';
  const h = Math.floor(s/3600);
  const m = Math.floor((s%3600)/60);
  if(h>0) return h+'h '+m+'m';
  return m+'m';
}

function refreshUI(){
  // totals
  const total = data.totals.seconds||0;
  const targetHours = Number(document.getElementById('target-hours').value) || 1;
  const targetSeconds = targetHours * 3600;
  const pct = Math.min(100, Math.round(total / targetSeconds * 100));
  const deg = Math.round(pct * 3.6);
  document.getElementById('ring').style.setProperty('--deg', deg+'deg');
  document.getElementById('percent').innerText = pct+'%';
  document.getElementById('time-text').innerText = secondsToHuman(total);
  document.getElementById('total-time-sm').innerText = secondsToHuman(total);
  document.getElementById('total-sessions').innerText = data.sessions.length || 0;

  // today
  const today = new Date().toISOString().slice(0,10);
  let todaySeconds = 0;
  for(const s of data.sessions){
    if(s.ts.slice(0,10) === today) todaySeconds += s.durationSeconds;
  }
  document.getElementById('today-time').innerText = Math.round(todaySeconds/60)+'m';

  // history list
  const hist = document.getElementById('history');
  hist.innerHTML = '';
  if(data.sessions.length===0){ hist.innerHTML = '<div class="small muted">No sessions yet.</div>'; return; }
  for(const s of data.sessions){
    const d = document.createElement('div'); d.className='session';
    const left = document.createElement('div'); left.style.flex='1';
    left.innerHTML = `<div style="font-weight:600">${secondsToHuman(s.durationSeconds)}</div><div class="small">${s.source}${s.videoId? ' • '+s.videoId: ''}</div>`;
    const right = document.createElement('div'); right.style.textAlign='right';
    right.innerHTML = `<div class="small">${new Date(s.ts).toLocaleString()}</div><div style="margin-top:6px"><button class="ghost" data-id="${s.id}" onclick="deleteSession(${s.id})">Delete</button></div>`;
    d.appendChild(left); d.appendChild(right); hist.appendChild(d);
  }
}

function deleteSession(id){
  data.sessions = data.sessions.filter(s=>s.id!==id);
  // recompute totals
  data.totals.seconds = data.sessions.reduce((acc,s)=>acc+s.durationSeconds,0);
  data.perVideo = {};
  for(const s of data.sessions){ if(s.videoId) data.perVideo[s.videoId]=(data.perVideo[s.videoId]||0)+s.durationSeconds; }
  saveStorage(data);
  refreshUI();
}

// YouTube API integration
function onYouTubeIframeAPIReady(){
  // placeholder - we create player when user loads URL
}

function extractVideoId(url){
  try{
    const u = new URL(url);
    if(u.hostname.includes('youtube.com')){
      return u.searchParams.get('v');
    } else if(u.hostname.includes('youtu.be')){
      return u.pathname.slice(1);
    }
  }catch(e){}
  // fallback: try regex
  const m = url.match(/(?:v=|\/)([0-9A-Za-z_-]{11})/);
  return m? m[1] : null;
}

function createPlayer(videoId){
  const playerDiv = document.createElement('div');
  playerDiv.id='ytplayer';
  const area = document.getElementById('player-area');
  area.innerHTML = '';
  area.appendChild(playerDiv);
  player = new YT.Player('ytplayer', {
    height: '240',
    width: '100%',
    videoId: videoId,
    playerVars: {enablejsapi:1,origin:location.origin,rel:0},
    events:{
      'onStateChange': onPlayerStateChange,
      'onReady': ()=>{console.log('player ready')}
    }
  });
  currentVideoId = videoId;
  lastPlayerTime = 0;
  lastPoll = Date.now();
}

function onPlayerStateChange(e){
  // YT states: -1 unstarted, 0 ended, 1 playing, 2 paused
  if(e.data === YT.PlayerState.PLAYING){
    isPlaying = true;
    startPolling();
  } else {
    isPlaying = false;
    // do one final poll to capture last seconds
    pollPlayer(true);
  }
}

function startPolling(){
  if(!player) return;
  if(window._st_polling) return;
  window._st_polling = setInterval(()=>pollPlayer(false), 1000);
}

function stopPolling(){
  if(window._st_polling){ clearInterval(window._st_polling); window._st_polling = null; }
}

function pollPlayer(force=false){
  if(!player || !player.getCurrentTime) return;
  try{
    const now = Date.now();
    const t = player.getCurrentTime(); // seconds float
    if(typeof t !== 'number' || isNaN(t)) return;
    if(lastPlayerTime === 0) { lastPlayerTime = t; lastPoll = now; return; }
    // delta should be t - lastPlayerTime, but if seek occurred huge change; guard it
    let delta = t - lastPlayerTime;
    if(delta < 0) delta = 0; // backward seek - don't count negative
    if(delta > 10) {
      // possibly user jumped forward; count at most 10s to avoid big jumps
      delta = 10;
    }
    if(delta >= 0.5 || force){
      // accumulate integer seconds
      const sec = Math.round(delta);
      if(sec > 0){
        createSession(sec, 'video', currentVideoId);
      }
      lastPlayerTime = t;
      lastPoll = now;
    }
  }catch(err){
    console.error('poll err', err);
  }
}

// UI wiring
document.getElementById('load-btn').addEventListener('click', ()=>{
  const url = document.getElementById('yt-url').value.trim();
  const id = extractVideoId(url);
  if(!id){ alert('Could not parse YouTube URL. Paste full link (https://www.youtube.com/watch?v=...)'); return; }
  createPlayer(id);
});
document.getElementById('clear-video').addEventListener('click', ()=>{
  const area = document.getElementById('player-area');
  area.innerHTML = '<div id="player-placeholder" style="color:#fff;font-size:15px">No video loaded</div>';
  if(player && player.destroy) player.destroy();
  player = null; currentVideoId = null;
  stopPolling();
});
document.getElementById('add-manual').addEventListener('click', ()=>{
  const min = Math.max(1, Number(document.getElementById('manual-min').value||0));
  createSession(min*60, 'manual', null);
});
document.getElementById('reset').addEventListener('click', ()=>{
  if(!confirm('Reset all stored study data? This cannot be undone.')) return;
  data = {sessions:[], totals:{seconds:0}, perVideo:{}, lastSessionId:0};
  saveStorage(data);
  refreshUI();
});
document.getElementById('target-hours').addEventListener('change', refreshUI);
document.getElementById('jump-10').addEventListener('click', ()=>createSession(10*60,'quick'));
document.getElementById('jump-30').addEventListener('click', ()=>createSession(30*60,'quick'));
document.getElementById('export-csv').addEventListener('click', ()=>{
  if(!data.sessions.length){ alert('No sessions to export'); return; }
  let csv = 'id,ts,source,videoId,durationSeconds\\n';
  for(const s of data.sessions.slice().reverse()){
    csv += `${s.id},${s.ts},${s.source},${s.videoId||''},${s.durationSeconds}\\n`;
  }
  const blob = new Blob([csv], {type:'text/csv'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = 'study-sessions.csv'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
});

document.getElementById('how-it-works').addEventListener('click', (e)=>{
  e.preventDefault();
  alert('How it works:\\n- Load a YouTube video.\\n- When video plays, tracker polls the player and records seconds when playing.\\n- Sessions stored locally in your browser.\\n- You can add manual sessions or export CSV for backup.');
});

// storage load & initial UI
refreshUI();
</script>
</body>
                                                                                                                                                                                 </html>
